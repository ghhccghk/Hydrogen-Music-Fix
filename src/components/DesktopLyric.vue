<template>
    <div class="arknights-desktop-lyric" :class="{ draggable: !locked }" @contextmenu="showContextMenu" @click="handleClick">
        <!-- ËÉåÊôØÂ±Ç -->
        <div class="background-layers">
            <div class="bg-layer bg-primary"></div>
            <div class="bg-layer bg-secondary"></div>
        </div>

        <!-- ÂÜÖÂÆπÂå∫Âüü -->
        <div class="lyric-content">
            <!-- È°∂ÈÉ®Áä∂ÊÄÅÊ†è -->
            <div class="status-bar">
                <div class="status-indicator" :class="{ active: playing }">
                    <div class="indicator-dot"></div>
                    <span class="status-text">{{ playing ? 'PLAYING' : 'PAUSED' }}</span>
                </div>
                <div class="lyric-controls">
                    <span class="font-size-label">{{ lyricFontSize }}PX</span>
                </div>
            </div>

            <!-- Ê≠åÊõ≤‰ø°ÊÅØÂå∫ -->
            <div class="song-info-section" v-if="currentSong">
                <div class="song-meta">
                    <div class="meta-row">
                        <span class="meta-label">TRACK</span>
                        <span class="meta-content">{{ currentSong.name || currentSong.localName || 'UNKNOWN' }}</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-label">ARTIST</span>
                        <span class="meta-content">{{ getArtistNames(currentSong) || 'UNKNOWN' }}</span>
                    </div>
                </div>
            </div>

            <!-- ‰∏ªÊ≠åËØçÊòæÁ§∫Âå∫Ôºà‰øùÁïôÊüìËâ≤ËøõÂ∫¶Êù°ÊïàÊûúÔºâ -->
            <div class="main-lyric-section">
                <div class="lyric-container">
                    <div class="lyric-prefix">></div>
                    <div
                        class="current-lyric"
                        ref="lyricElementRef"
                        :data-lyric="currentLyricText"
                        :style="{
                            fontSize: lyricFontSize + 'px',
                            opacity: currentLyricOpacity,
                        }"
                    >
                        {{ currentLyricText }}
                    </div>
                </div>

                <!-- ‰∏ã‰∏ÄÂè•Ê≠åËØçÈ¢ÑËßà -->
                <div class="next-lyric-preview" v-if="nextLyricText">
                    <div class="preview-indicator">NEXT</div>
                    <div
                        class="next-lyric"
                        :style="{
                            fontSize: lyricFontSize * 0.75 + 'px',
                            opacity: nextLyricOpacity,
                        }"
                    >
                        {{ nextLyricText }}
                    </div>
                </div>
            </div>

            <!-- ËøõÂ∫¶ÊåáÁ§∫Âô® -->
            <div class="progress-section" v-if="lyricsArray.length > 0">
                <div class="progress-label">LYRIC PROGRESS</div>
                <div class="progress-bar">
                    <div class="progress-fill" :style="{ width: progressPercentage + '%' }"></div>
                    <div class="progress-indicator"></div>
                </div>
                <div class="progress-info">
                    <span>{{ currentLyricIndex + 1 }}</span>
                    <span>/</span>
                    <span>{{ lyricsArray.length }}</span>
                </div>
            </div>
        </div>

        <!-- ÊòéÊó•ÊñπËàüÈ£éÊ†ºÂè≥ÈîÆËèúÂçï -->
        <div class="arknights-context-menu" v-if="contextMenuVisible" :style="{ left: contextMenuX + 'px', top: contextMenuY + 'px' }" @click.stop>
            <div class="menu-header">
                <span class="menu-title">DESKTOP LYRIC</span>
                <div class="title-underline"></div>
            </div>

            <div class="menu-content">
                <!-- Ëá™Âä®ÈÄâÊã©ÈÄâÈ°π -->
                <div class="menu-item" @click="selectLyricType('auto')">
                    <div class="item-icon">{{ selectedLyricType === 'auto' ? 'üîò' : '‚ö™' }}</div>
                    <span class="item-text">AUTO SELECT</span>
                    <div class="item-indicator"></div>
                </div>

                <!-- ÂéüÊ≠åËØçÈÄâÈ°π -->
                <div class="menu-item" v-if="hasLyricType('original')" @click="selectLyricType('original')">
                    <div class="item-icon">{{ selectedLyricType === 'original' ? 'üîò' : '‚ö™' }}</div>
                    <span class="item-text">ORIGINAL</span>
                    <div class="item-indicator"></div>
                </div>

                <!-- ÁøªËØëÊ≠åËØçÈÄâÈ°π -->
                <div class="menu-item" v-if="hasLyricType('trans')" @click="selectLyricType('trans')">
                    <div class="item-icon">{{ selectedLyricType === 'trans' ? 'üîò' : '‚ö™' }}</div>
                    <span class="item-text">TRANSLATION</span>
                    <div class="item-indicator"></div>
                </div>

                <!-- ÁΩóÈ©¨Èü≥ÈÄâÈ°π -->
                <div class="menu-item" v-if="hasLyricType('roma')" @click="selectLyricType('roma')">
                    <div class="item-icon">{{ selectedLyricType === 'roma' ? 'üîò' : '‚ö™' }}</div>
                    <span class="item-text">ROMANIZATION</span>
                    <div class="item-indicator"></div>
                </div>

                <div class="menu-separator">
                    <div class="separator-line"></div>
                </div>

                <div class="menu-item" @click="toggleLock">
                    <div class="item-icon">üîí</div>
                    <span class="item-text">{{ locked ? 'UNLOCK POSITION' : 'LOCK POSITION' }}</span>
                    <div class="item-indicator"></div>
                </div>

                <div class="menu-item" @click="adjustFontSize(2)">
                    <div class="item-icon">‚ûï</div>
                    <span class="item-text">INCREASE FONT</span>
                    <div class="item-indicator"></div>
                </div>

                <div class="menu-item" @click="adjustFontSize(-2)">
                    <div class="item-icon">‚ûñ</div>
                    <span class="item-text">DECREASE FONT</span>
                    <div class="item-indicator"></div>
                </div>

                <div class="menu-separator">
                    <div class="separator-line"></div>
                </div>

                <div class="menu-item danger" @click="closeLyric">
                    <div class="item-icon">‚úï</div>
                    <span class="item-text">CLOSE LYRIC</span>
                    <div class="item-indicator"></div>
                </div>
            </div>
        </div>
    </div>
</template>

<script setup>
import { ref, computed, onMounted, onUnmounted } from 'vue';

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const currentSong = ref(null);
const lyricsArray = ref([]);
const currentLyricIndex = ref(-1);
const progress = ref(0);
const playing = ref(false);
const locked = ref(false);
const lyricFontSize = ref(22);

// Ê°åÈù¢Ê≠åËØçÊòæÁ§∫Á±ªÂûãÈÖçÁΩÆ - ÂçïÈÄâÊ®°Âºè
const selectedLyricType = ref('auto'); // 'auto' | 'original' | 'trans' | 'roma'

// ÂêåÊ≠•Êâ´ÊèèÂä®ÁîªÊéßÂà∂
const scanAnimationRef = ref(null);
const lyricElementRef = ref(null);

// ÂêØÂä®ÂêåÊ≠•Êâ´ÊèèÂä®Áîª
const startScanAnimation = () => {
    if (scanAnimationRef.value) {
        cancelAnimationFrame(scanAnimationRef.value);
    }

    let startTime = null;
    const duration = 10000; // 10Áßí‰∏Ä‰∏™Âæ™ÁéØ

    const animate = currentTime => {
        if (!startTime) startTime = currentTime;
        const elapsed = currentTime - startTime;
        const cycleProgress = (elapsed % duration) / duration; // 0-1‰πãÈó¥ÁöÑÂæ™ÁéØËøõÂ∫¶

        // ËÆ°ÁÆóÈªëËâ≤ËøõÂ∫¶Êù°ÁöÑ‰ΩçÁΩÆ
        let scanProgress;
        let textClipProgress;

        if (cycleProgress <= 0.05) {
            // ÂàùÂßãÈò∂ÊÆµ (0%-5%)
            scanProgress = -100;
            textClipProgress = 0;
        } else if (cycleProgress <= 0.35) {
            // Êâ´ÊèèËøõÂÖ•Èò∂ÊÆµ (5%-35%)
            const phase = (cycleProgress - 0.05) / 0.3; // 0-1
            scanProgress = -100 + phase * 100; // -100% Âà∞ 0%
            // ÊñáÂ≠óÂèòÂåñÁ®çÂæÆÂª∂ËøüÔºåËÄÉËôëpadding
            const textPhase = Math.max(0, (phase - 0.025) / 0.975); // Âª∂Ëøü8%ÂºÄÂßã
            textClipProgress = textPhase * 100;
        } else if (cycleProgress <= 0.65) {
            // ÂÅúÈ°øÈò∂ÊÆµ (35%-65%)
            scanProgress = 0;
            textClipProgress = 100;
        } else if (cycleProgress <= 0.9) {
            // Ê∏ÖÈô§ÈÄÄÂá∫Èò∂ÊÆµ (65%-90%)
            const phase = (cycleProgress - 0.65) / 0.25; // 0-1
            scanProgress = phase * 100; // 0% Âà∞ 100%
            // ÊñáÂ≠óÊ∏ÖÈô§Á®çÂæÆÂª∂ËøüÔºåËÆ©ÈªëËâ≤Êù°Ê∏ÖÈô§Âà∞ÊñáÂ≠ó‰ΩçÁΩÆÊó∂ÊñáÂ≠óÊâçÂºÄÂßãÂèòÈªë
            const textPhase = Math.max(0, (phase - 0.025) / 0.975); // Âª∂Ëøü6%ÂºÄÂßãÔºåÁ®çÂæÆÂø´‰∏ÄÁÇπ
            textClipProgress = 100 - textPhase * 100; // ‰ªé100%ÂèòÂà∞0%
        } else {
            // ÊúÄÂêéÈò∂ÊÆµ (90%-100%)
            scanProgress = 100;
            textClipProgress = 0;
        }

        // Â∫îÁî®CSSÂèòÈáè
        if (lyricElementRef.value) {
            lyricElementRef.value.style.setProperty('--scan-progress', `${scanProgress}%`);

            // Ê†πÊçÆ‰∏çÂêåÈò∂ÊÆµËÆæÁΩÆ‰∏çÂêåÁöÑclip-pathÊñπÂêë
            if (cycleProgress <= 0.65) {
                // Êâ´ÊèèÂíåÂÅúÈ°øÈò∂ÊÆµÔºö‰ªéÂ∑¶ÂêëÂè≥ÊòæÁ§∫ÁôΩËâ≤ÊñáÂ≠ó
                lyricElementRef.value.style.setProperty('--text-clip', `polygon(0% 0%, ${textClipProgress}% 0%, ${textClipProgress}% 100%, 0% 100%)`);
            } else {
                // Ê∏ÖÈô§Èò∂ÊÆµÔºö‰ªéÂ∑¶ÂêëÂè≥ÈöêËóèÁôΩËâ≤ÊñáÂ≠óÔºàËÆ©ÈªëËâ≤ÊñáÂ≠ó‰ªéÂ∑¶ÂêëÂè≥ÊòæÁ§∫Ôºâ
                // textClipProgress‰ªé100%ÂèòÂà∞0%ÔºåÊâÄ‰ª•ÁôΩËâ≤ÊñáÂ≠ó‰ªéÂè≥ËæπÂºÄÂßãÊ∂àÂ§±
                // Êàë‰ª¨ÈúÄË¶ÅËÆ©ÁôΩËâ≤ÊñáÂ≠ó‰ªéÂ∑¶ËæπÂºÄÂßãÊ∂àÂ§±ÔºåÊâÄ‰ª•‰ΩøÁî®(100-textClipProgress)‰Ωú‰∏∫Âè≥ËæπÁïå
                const leftBoundary = 100 - textClipProgress;
                lyricElementRef.value.style.setProperty('--text-clip', `polygon(${leftBoundary}% 0%, 100% 0%, 100% 100%, ${leftBoundary}% 100%)`);
            }
        }

        scanAnimationRef.value = requestAnimationFrame(animate);
    };

    scanAnimationRef.value = requestAnimationFrame(animate);
};

// Âè≥ÈîÆËèúÂçïÁõ∏ÂÖ≥
const contextMenuVisible = ref(false);
const contextMenuX = ref(0);
const contextMenuY = ref(0);

// ËÆ°ÁÆóÂ±ûÊÄß
const currentLyricText = computed(() => {
    if (!currentSong.value) {
        return '‚ô™ Á≠âÂæÖÊ≠åÊõ≤Êï∞ÊçÆ ‚ô™';
    }

    if (!lyricsArray.value || lyricsArray.value.length === 0) {
        return '‚ô™ ÊöÇÊó†Ê≠åËØç ‚ô™';
    }

    if (currentLyricIndex.value < 0 || currentLyricIndex.value >= lyricsArray.value.length) {
        const firstLyric = lyricsArray.value[0];
        return formatLyricText(firstLyric);
    }

    const lyric = lyricsArray.value[currentLyricIndex.value];
    return formatLyricText(lyric);
});

const nextLyricText = computed(() => {
    if (!lyricsArray.value.length || currentLyricIndex.value < 0 || currentLyricIndex.value >= lyricsArray.value.length - 1) {
        return '';
    }
    const nextLyric = lyricsArray.value[currentLyricIndex.value + 1];
    return formatLyricText(nextLyric);
});

// Ê†ºÂºèÂåñÊ≠åËØçÊñáÊú¨ÔºàÂçïÈÄâÊ®°ÂºèÔºâ
const formatLyricText = (lyricObj) => {
    if (!lyricObj) return '‚ô™';
    
    // Ê†πÊçÆÈÄâÊã©ÁöÑÁ±ªÂûãËøîÂõûÂØπÂ∫îÊ≠åËØç
    switch (selectedLyricType.value) {
        case 'original':
            return lyricObj.lyric || '‚ô™';
        case 'trans':
            return lyricObj.tlyric || '‚ô™';
        case 'roma':
            return lyricObj.rlyric || '‚ô™';
        case 'auto':
        default:
            // Ëá™Âä®ÈÄâÊã©ÔºöÁøªËØë‰ºòÂÖàÔºåÊ≤°ÊúâÁøªËØëÂàôÊòæÁ§∫ÂéüÊ≠åËØç
            return lyricObj.tlyric || lyricObj.lyric || '‚ô™';
    }
};

const currentLyricOpacity = computed(() => {
    return playing.value ? 1 : 0.6;
});

const nextLyricOpacity = computed(() => {
    return playing.value ? 0.7 : 0.4;
});

// Ê≠åËØçËøõÂ∫¶ÁôæÂàÜÊØî
const progressPercentage = computed(() => {
    if (!lyricsArray.value.length || currentLyricIndex.value < 0) {
        return 0;
    }
    return ((currentLyricIndex.value + 1) / lyricsArray.value.length) * 100;
});

// ËæÖÂä©ÂáΩÊï∞
const getArtistNames = song => {
    if (!song) return '';
    if (song.type === 'local') {
        return song.ar || 'Êú™Áü•Ëâ∫ÊúØÂÆ∂';
    }
    return song.ar?.map(artist => artist.name).join(' / ') || 'Êú™Áü•Ëâ∫ÊúØÂÆ∂';
};

// IPC ÈÄö‰ø°Â§ÑÁêÜ
const handleLyricUpdate = (event, data) => {
    try {
        if (data.type === 'song-change') {
            currentSong.value = data.song;
            lyricsArray.value = data.lyrics || [];
            currentLyricIndex.value = -1;
            // ÂΩìÊ≠åÊõ≤ÂàáÊç¢Êó∂ÔºåË∞ÉÁî®Ëá™Âä®ÈÄâÊã©ÈÄªËæë
            autoSelectLyricType();
        } else if (data.type === 'lyric-progress') {
            currentLyricIndex.value = data.currentIndex;
            progress.value = data.progress;
        } else if (data.type === 'play-state') {
            playing.value = data.playing;
        }
    } catch (error) {
        // ÈùôÈªòÂ§ÑÁêÜÈîôËØØ
    }
};

// Âè≥ÈîÆËèúÂçïÁõ∏ÂÖ≥
const showContextMenu = event => {
    event.preventDefault();
    
    // Ëé∑ÂèñÁ™óÂè£Â∞∫ÂØ∏
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;
    
    // ‰º∞ÁÆóËèúÂçïÂ∞∫ÂØ∏ÔºàÂü∫‰∫éËèúÂçïÈ°πÊï∞ÈáèÔºâ
    const menuItemHeight = 40; // ÊØè‰∏™ËèúÂçïÈ°πÁöÑÈ´òÂ∫¶
    const menuHeader = 50; // ËèúÂçïÂ§¥ÈÉ®È´òÂ∫¶
    const menuSeparators = 20; // ÂàÜÈöîÁ¨¶È´òÂ∫¶
    
    // ËÆ°ÁÆóÊúâÂ§öÂ∞ë‰∏™ËèúÂçïÈ°π
    let menuItemCount = 1; // AUTO SELECT
    if (hasLyricType('original')) menuItemCount++;
    if (hasLyricType('trans')) menuItemCount++;
    if (hasLyricType('roma')) menuItemCount++;
    menuItemCount += 3; // ÈîÅÂÆö„ÄÅÂ¢ûÂ§ßÂ≠ó‰Ωì„ÄÅÂáèÂ∞èÂ≠ó‰Ωì
    menuItemCount += 1; // ÂÖ≥Èó≠Ê≠åËØç
    
    const estimatedMenuHeight = menuHeader + (menuItemCount * menuItemHeight) + (2 * menuSeparators);
    const menuWidth = 200; // ËèúÂçïÂÆΩÂ∫¶
    
    // Êô∫ËÉΩÂÆö‰ΩçÔºöÈÅøÂÖçËèúÂçïË∂ÖÂá∫Â±èÂπï
    let menuX = event.clientX;
    let menuY = event.clientY;
    
    // Ê∞¥Âπ≥ÂÆö‰ΩçË∞ÉÊï¥
    if (menuX + menuWidth > windowWidth) {
        menuX = Math.max(0, event.clientX - menuWidth);
    }
    
    // ÂûÇÁõ¥ÂÆö‰ΩçË∞ÉÊï¥
    if (menuY + estimatedMenuHeight > windowHeight) {
        menuY = Math.max(0, event.clientY - estimatedMenuHeight);
    }
    
    contextMenuX.value = menuX;
    contextMenuY.value = menuY;
    contextMenuVisible.value = true;
};

const hideContextMenu = () => {
    contextMenuVisible.value = false;
};

const handleClick = () => {
    if (contextMenuVisible.value) {
        hideContextMenu();
    }
};

// ËèúÂçïÂäüËÉΩ
const toggleLock = () => {
    locked.value = !locked.value;
    if (window.electronAPI) {
        window.electronAPI.setLyricWindowMovable(!locked.value);
    }
    hideContextMenu();
};

const adjustFontSize = delta => {
    lyricFontSize.value = Math.max(16, Math.min(48, lyricFontSize.value + delta));
    hideContextMenu();
};

const closeLyric = () => {
    if (window.electronAPI) {
        // ÂÖàÈÄöÁü•‰∏ªÁ™óÂè£Ê°åÈù¢Ê≠åËØçÂç≥Â∞ÜÂÖ≥Èó≠
        window.electronAPI.notifyLyricWindowClosed();
        // ÁÑ∂ÂêéÂÖ≥Èó≠Á™óÂè£
        window.electronAPI.closeLyricWindow();
    }
    hideContextMenu();
};

// Ê≠åËØçÊòæÁ§∫Ê®°ÂºèÂàáÊç¢
const selectLyricType = (type) => {
    selectedLyricType.value = type;
    hideContextMenu();
};

// Ëá™Âä®ÈÄâÊã©ÊúÄ‰Ω≥Ê≠åËØçÁ±ªÂûãÔºàÂΩìÊ≠åÊõ≤ÂàáÊç¢Êó∂Ë∞ÉÁî®Ôºâ
const autoSelectLyricType = () => {
    if (selectedLyricType.value !== 'auto') return; // Â¶ÇÊûúÁî®Êà∑ÊâãÂä®ÈÄâÊã©‰∫ÜÁ±ªÂûãÔºå‰∏çËá™Âä®ÂàáÊç¢
    
    if (!lyricsArray.value || lyricsArray.value.length === 0) return;
    
    // Ê£ÄÊü•Á¨¨‰∏ÄÂè•Ê≠åËØçÊù•ÂÜ≥ÂÆöÈªòËÆ§ÈÄâÊã©
    const firstLyric = lyricsArray.value[0];
    if (!firstLyric) return;
    
    // ÁøªËØë‰ºòÂÖàÔºåÊ≤°ÊúâÁøªËØëÂàôÈÄâÂéüÊ≠åËØç
    if (firstLyric.tlyric && firstLyric.tlyric.trim()) {
        // ÊúâÁøªËØëÔºå‰øùÊåÅautoÊ®°ÂºèÂç≥ÂèØ
        return;
    } else if (firstLyric.lyric && firstLyric.lyric.trim()) {
        // Ê≤°ÊúâÁøªËØë‰ΩÜÊúâÂéüÊ≠åËØçÔºå‰øùÊåÅautoÊ®°ÂºèÂç≥ÂèØ
        return;
    }
};

// Ëé∑ÂèñÂΩìÂâçÊ≠åËØçÂØπË±°
const getCurrentLyricObj = () => {
    if (!lyricsArray.value || lyricsArray.value.length === 0) return null;
    if (currentLyricIndex.value < 0 || currentLyricIndex.value >= lyricsArray.value.length) {
        return lyricsArray.value[0];
    }
    return lyricsArray.value[currentLyricIndex.value];
};

// Ê£ÄÊü•ÂΩìÂâçÊ≠åÊõ≤ÊòØÂê¶ÊúâÁâπÂÆöÁ±ªÂûãÁöÑÊ≠åËØç
const hasLyricType = (type) => {
    if (!lyricsArray.value || lyricsArray.value.length === 0) return false;
    
    const checkField = type === 'original' ? 'lyric' : 
                      type === 'trans' ? 'tlyric' : 'rlyric';
    
    return lyricsArray.value.some(item => item[checkField] && item[checkField].trim() !== '');
};

// ÁîüÂëΩÂë®Êúü
onMounted(() => {
    if (window.electronAPI) {
        try {
            window.electronAPI.onLyricUpdate(handleLyricUpdate);
            window.electronAPI.requestLyricData();
        } catch (error) {
            // ÈùôÈªòÂ§ÑÁêÜÈîôËØØ
        }
    }

    document.addEventListener('click', hideContextMenu);
    document.addEventListener('contextmenu', e => {
        if (!e.target.closest('.desktop-lyric')) {
            e.preventDefault();
        }
    });

    // ÂêØÂä®ÂêåÊ≠•Êâ´ÊèèÂä®Áîª
    startScanAnimation();
});

onUnmounted(() => {
    document.removeEventListener('click', hideContextMenu);

    // Ê∏ÖÁêÜÂä®Áîª
    if (scanAnimationRef.value) {
        cancelAnimationFrame(scanAnimationRef.value);
    }
});
</script>

<style scoped lang="scss">
// ÊòéÊó•ÊñπËàüÈ£éÊ†ºÊ°åÈù¢Ê≠åËØçÊ†∑ÂºèÔºàÂéªÊéâÂõõËßíË£ÖÈ•∞Ôºâ
.arknights-desktop-lyric {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: 100%;

    font-family: 'SourceHanSansCN-Bold', 'Bender-Bold', monospace;
    user-select: none;
    overflow: hidden;
    
    /* WindowsÈÄèÊòéÂ∫¶‰ºòÂåñ */
    background: transparent !important;
    -webkit-app-region: no-drag;

    // ËøõÂÖ•Âä®Áîª - ÊîπËøõÁâàÊú¨ÔºåÊõ¥ÊµÅÁïÖ
    animation: lyricWindowAppear 0.6s cubic-bezier(0.4, 0, 0.12, 1) forwards;

    @keyframes lyricWindowAppear {
        0% {
            opacity: 0;
            transform: scale(0.9) translateY(20px);
        }
        60% {
            opacity: 0.8;
            transform: scale(1.02) translateY(-2px);
        }
        100% {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    // Á¶ªÂºÄÂä®Áîª
    &.lyric-window-leaving {
        animation: lyricWindowDisappear 0.4s cubic-bezier(0.3, 0.79, 0.55, 0.99) forwards;
    }

    @keyframes lyricWindowDisappear {
        0% {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
        100% {
            opacity: 0;
            transform: scale(0.85) translateY(15px);
        }
    }

    &.draggable {
        -webkit-app-region: drag;
        cursor: move;
    }
}

// ËÉåÊôØÂàÜÂ±ÇÁ≥ªÁªü
.background-layers {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1;

    .bg-layer {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;

        &.bg-primary {
            // ‰∏é‰∏ªÊí≠ÊîæÂô®‰∏ÄËá¥ÁöÑËìùÁªøËâ≤Ê∏êÂèòËÉåÊôØ
            background: linear-gradient(rgba(176, 209, 217, 0.95) -20%, rgba(176, 209, 217, 0.7) 50%, rgba(176, 209, 217, 0.95) 120%);
            backdrop-filter: blur(20px);
        }

        &.bg-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.1);
            margin: 8px;
        }
    }
}

// ‰∏ªÂÜÖÂÆπÂå∫Âüü
.lyric-content {
    position: relative;
    width: 100%;
    height: 100%;
    padding: 16px;
    z-index: 5;

    display: flex;
    flex-direction: column;
    gap: 12px;
    min-height: 0;
}

// È°∂ÈÉ®Áä∂ÊÄÅÊ†è
.status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    height: 24px;

    .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;

        .indicator-dot {
            width: 8px;
            height: 8px;
            border: 1px solid rgba(0, 0, 0, 0.5);
            background: rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .status-text {
            font-family: 'Bender-Bold', monospace;
            font-size: 9px;
            font-weight: bold;
            color: rgba(0, 0, 0, 0.6);
            letter-spacing: 1px;
        }

        &.active {
            .indicator-dot {
                background: #000000;
                border-color: #000000;
                box-shadow: 0 0 8px rgba(0, 0, 0, 0.5);
                animation: statusPulse 2s ease-in-out infinite;
            }

            .status-text {
                color: #000000;
            }
        }
    }

    .lyric-controls {
        .font-size-label {
            font-family: 'Bender-Bold', monospace;
            font-size: 9px;
            font-weight: bold;
            color: rgba(0, 0, 0, 0.5);
            letter-spacing: 1px;
        }
    }

    @keyframes statusPulse {
        0%,
        100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.2);
        }
    }
}

// Ê≠åÊõ≤‰ø°ÊÅØÂå∫Âüü
.song-info-section {
    position: relative;
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(0, 0, 0, 0.1);
    padding: 8px 12px;
    flex-shrink: 0;

    .song-meta {
        position: relative;
        z-index: 2;

        .meta-row {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            gap: 12px;

            &:last-child {
                margin-bottom: 0;
            }

            .meta-label {
                font-family: 'Bender-Bold', monospace;
                font-size: 8px;
                font-weight: bold;
                color: rgba(0, 0, 0, 0.6);
                letter-spacing: 1px;
                min-width: 40px;
                text-align: right;
            }

            .meta-content {
                font-family: 'SourceHanSansCN-Bold';
                font-size: 12px;
                font-weight: bold;
                color: #000000;
                flex: 1;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
        }
    }
}

// ‰∏ªÊ≠åËØçÊòæÁ§∫Âå∫Âüü
.main-lyric-section {
    position: relative;
    flex: 1;
    background: rgba(255, 255, 255, 0.15);
    border: 2px solid rgba(0, 0, 0, 0.2);
    min-height: 120px;

    display: flex;
    flex-direction: column;
    justify-content: center;

    .lyric-container {
        position: relative;
        z-index: 2;
        display: flex;
        align-items: center;
        padding: 16px 20px;
        gap: 12px;

        .lyric-prefix {
            font-family: 'Bender-Bold', monospace;
            font-size: 16px;
            font-weight: bold;
            color: #666666; // Êîπ‰∏∫ÁÅ∞Ëâ≤
            text-shadow: 0 0 8px rgba(102, 102, 102, 0.6);
            animation: prefixGlow 3s ease-in-out infinite alternate;
        }

        .current-lyric {
            font-family: 'SourceHanSansCN-Bold';
            flex: 1;
            text-align: left;
            max-width: 400px; // ÈÄÇÈÖçÊõ¥Áü≠ÁöÑÁ™óÂè£
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.4;
            min-height: 60px;
            position: relative;
            overflow: hidden;

            // ‰ΩøÁî®JavaScriptÊéßÂà∂ÁöÑÂêåÊ≠•ËøõÂ∫¶Êù°Êâ´ÊèèÊïàÊûú
            background: rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;

            // ÈªëËâ≤ËøõÂ∫¶Êù°Â±Ç
            &::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                transform: translateX(var(--scan-progress, -100%));
                transition: none;
                z-index: 1;
            }

            padding: 12px 16px;
            border-radius: 0; // Áõ¥ËßíËÆæËÆ°
            color: #000000;

            // ÁôΩËâ≤ÊñáÂ≠óÈÅÆÁΩ©Â±Ç - ‰ΩøÁî®JavaScriptÊéßÂà∂ÂÆûÁé∞ÂÆåÁæéÂêåÊ≠•
            &::before {
                content: attr(data-lyric);
                position: absolute;
                top: 12px;
                left: 16px;
                right: 16px;
                bottom: 12px;
                color: #ffffff;
                font-weight: bold;
                line-height: 1.4;
                word-wrap: break-word;
                overflow-wrap: break-word;
                pointer-events: none;
                z-index: 2;
                text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);

                // ‰ΩøÁî®JavaScriptÊéßÂà∂ÁöÑÈÅÆÁΩ©Ôºå‰∏éËøõÂ∫¶Êù°ÂÆåÂÖ®ÂêåÊ≠•
                clip-path: var(--text-clip, polygon(0% 0%, 0% 0%, 0% 100%, 0% 100%));
                transition: none;
            }
        }
    }

    .next-lyric-preview {
        position: relative;
        z-index: 2;
        display: flex;
        align-items: center;
        padding: 6px 20px 10px;
        gap: 10px;
        border-top: 1px solid rgba(0, 0, 0, 0.1);

        .preview-indicator {
            font-family: 'Bender-Bold', monospace;
            font-size: 8px;
            font-weight: bold;
            color: rgba(0, 0, 0, 0.5);
            letter-spacing: 1px;
            min-width: 30px;
        }

        .next-lyric {
            font-family: 'SourceHanSansCN-Bold';
            color: rgba(0, 0, 0, 0.6);
            line-height: 1.3;
            flex: 1;
            text-align: left;
            word-wrap: break-word;
        }
    }

    @keyframes prefixGlow {
        0% {
            text-shadow: 0 0 8px rgba(102, 102, 102, 0.6);
        }
        100% {
            text-shadow: 0 0 15px rgba(102, 102, 102, 0.9), 0 0 25px rgba(102, 102, 102, 0.4);
        }
    }
}

// ËøõÂ∫¶ÊåáÁ§∫Âô®
.progress-section {
    display: flex;
    flex-direction: column;
    gap: 6px;
    flex-shrink: 0;
    background: rgba(255, 255, 255, 0.05);
    padding: 8px 12px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    border-radius: 0; // Áõ¥ËßíËÆæËÆ°

    .progress-label {
        font-family: 'Bender-Bold', monospace;
        font-size: 8px;
        font-weight: bold;
        color: rgba(0, 0, 0, 0.6);
        letter-spacing: 1px;
        text-align: center;
    }

    .progress-bar {
        position: relative;
        height: 4px;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(0, 0, 0, 0.3);
        border-radius: 0; // Áõ¥ËßíËÆæËÆ°
        overflow: hidden;

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #000000, #333333);
            transition: width 0.5s ease;
            position: relative;

            &::after {
                content: '';
                position: absolute;
                top: 0;
                right: -8px;
                width: 8px;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8));
                animation: progressShine 2s ease-in-out infinite;
            }
        }

        .progress-indicator {
            position: absolute;
            top: -2px;
            right: 0;
            width: 8px;
            height: 8px;
            background: #000000;
            border: 1px solid #333333;
            border-radius: 0; // Áõ¥ËßíËÆæËÆ°
            opacity: 0.8;
        }
    }

    .progress-info {
        display: flex;
        justify-content: center;
        gap: 4px;

        span {
            font-family: 'Bender-Bold', monospace;
            font-size: 8px;
            font-weight: bold;
            color: rgba(0, 0, 0, 0.5);
            letter-spacing: 1px;
        }
    }

    @keyframes progressShine {
        0%,
        100% {
            opacity: 0;
        }
        50% {
            opacity: 1;
        }
    }
}

// ÊòéÊó•ÊñπËàüÈ£éÊ†ºÂè≥ÈîÆËèúÂçï
.arknights-context-menu {
    position: fixed;
    min-width: 200px;
    max-width: 250px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border: 2px solid rgba(0, 0, 0, 0.2);
    border-radius: 0; // Áõ¥ËßíËÆæËÆ°
    z-index: 999999; // ÊûÅÈ´òÂ±ÇÁ∫ßÁ°Æ‰øùÊòæÁ§∫Âú®ÊúÄÈ°∂Â±Ç
    -webkit-app-region: no-drag;
    
    // Á°Æ‰øùËèúÂçïÂèØ‰ª•Ë∂ÖÂá∫Áà∂ÂÆπÂô®ÂíåÁ™óÂè£ËæπÁïå
    overflow-x: hidden; // ÈöêËóèÊ∞¥Âπ≥ÊªöÂä®Êù°
    overflow-y: auto; // ‰øùÊåÅÂûÇÁõ¥ÊªöÂä®
    
    // ÊúÄÂ§ßÈ´òÂ∫¶ÈôêÂà∂ÔºåÈò≤Ê≠¢ËèúÂçïËøáÈïø
    max-height: 85vh;
    
    // Á°Æ‰øùËèúÂçïÂÜÖÂÆπÂÆåÊï¥ÊòæÁ§∫
    box-sizing: border-box;
    
    // Èò≤Ê≠¢ËèúÂçïÂÜÖÂÆπË¢´Êà™Êñ≠
    contain: none;

    animation: menuSlideIn 0.4s cubic-bezier(0.4, 0, 0.12, 1) forwards;

    @keyframes menuSlideIn {
        0% {
            opacity: 0;
            transform: scale(0.9) translateY(-15px);
        }
        60% {
            opacity: 0.9;
            transform: scale(1.02) translateY(2px);
        }
        100% {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .menu-header {
        padding: 12px 16px 8px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        // ‰∏éÊ°åÈù¢Ê≠åËØç‰∏ÄËá¥ÁöÑÊòéÊó•ÊñπËàüËìùÁªøËâ≤Ê∏êÂèòËÉåÊôØÔºåÊõ¥ÊµÖÁöÑËâ≤Ë∞É
        background: linear-gradient(rgba(176, 209, 217, 0.75) -20%, rgba(176, 209, 217, 0.60) 50%, rgba(176, 209, 217, 0.75) 120%);
        backdrop-filter: blur(8px); // Ê∑ªÂä†Ê®°Á≥äÊïàÊûúÂ¢ûÂº∫ÈÅÆÁõñÊïàÊûú
        flex-shrink: 0; // Èò≤Ê≠¢Â§¥ÈÉ®Ë¢´ÂéãÁº©
        position: sticky;
        top: 0;
        z-index: 10; // ÊèêÈ´òz-indexÁ°Æ‰øùÊ†áÈ¢òÂßãÁªàÂú®ÊúÄ‰∏äÂ±Ç
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); // Ê∑ªÂä†Èò¥ÂΩ±Â¢ûÂº∫Â±ÇÊ¨°ÊÑü

        .menu-title {
            font-family: 'Bender-Bold', monospace;
            font-size: 11px;
            font-weight: bold;
            color: #000000;
            letter-spacing: 1px;
        }

        .title-underline {
            width: 40px;
            height: 2px;
            background: #000000;
            margin-top: 4px;
        }
    }

    .menu-content {
        padding: 8px 0;
        display: flex;
        flex-direction: column;
        min-height: 0; // ÂÖÅËÆ∏ÂÜÖÂÆπÊî∂Áº©
    }

    .menu-item {
        display: flex;
        align-items: center;
        padding: 8px 20px 8px 16px; // Âè≥ËæπÂ§öÁïô4pxÁ©∫Èó¥ÁªôÂÅèÁßªÂä®Áîª
        cursor: pointer;
        transition: all 0.2s ease;
        gap: 12px;
        position: relative;
        -webkit-app-region: no-drag;
        flex-shrink: 0; // Èò≤Ê≠¢ËèúÂçïÈ°πË¢´ÂéãÁº©
        min-height: 36px; // ËÆæÁΩÆÊúÄÂ∞èÈ´òÂ∫¶
        box-sizing: border-box; // Á°Æ‰øùpadding‰∏ç‰ºöÂØºËá¥Ê∫¢Âá∫

        &:hover {
            background: rgba(0, 0, 0, 0.1);
            transform: translateX(4px); // ÊÅ¢Â§çÂêëÂè≥ÂÅèÁßªÂä®Áîª
            padding-right: 16px; // hoverÊó∂ÂáèÂ∞ëÂè≥padding‰øùÊåÅÊÄªÂÆΩÂ∫¶‰∏çÂèò

            .item-icon {
                transform: scale(1.1);
            }

            .item-indicator {
                opacity: 1;
                transform: scaleX(1);
            }
        }

        &.danger:hover {
            background: rgba(255, 69, 58, 0.2);
            color: #ff453a;

            .item-icon {
                filter: drop-shadow(0 0 5px rgba(255, 69, 58, 0.5));
            }
        }

        .item-icon {
            font-size: 12px;
            width: 16px;
            text-align: center;
            transition: all 0.2s ease;
            flex-shrink: 0; // Èò≤Ê≠¢ÂõæÊ†áË¢´ÂéãÁº©
        }

        .item-text {
            font-family: 'Bender-Bold', monospace;
            font-size: 10px;
            font-weight: bold;
            color: #000000;
            letter-spacing: 0.5px;
            flex: 1;
            white-space: nowrap; // Èò≤Ê≠¢ÊñáÂ≠óÊç¢Ë°å
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-indicator {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #000000;
            opacity: 0;
            transform: scaleX(0);
            transform-origin: right;
            transition: all 0.2s ease;
        }
    }

    .menu-separator {
        margin: 4px 0;
        padding: 0 16px;
        flex-shrink: 0; // Èò≤Ê≠¢ÂàÜÈöîÁ¨¶Ë¢´ÂéãÁº©

        .separator-line {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.3), transparent);
        }
    }

    // Ëá™ÂÆö‰πâÊªöÂä®Êù°Ê†∑Âºè
    &::-webkit-scrollbar {
        width: 6px;
    }

    &::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 0;
    }

    &::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.4);
        border-radius: 0;
        
        &:hover {
            background: rgba(0, 0, 0, 0.6);
        }
        
        &:active {
            background: rgba(0, 0, 0, 0.8);
        }
    }

    // ÊªöÂä®Êù°ËßíËêΩ
    &::-webkit-scrollbar-corner {
        background: transparent;
    }
}

// ÂìçÂ∫îÂºèËÆæËÆ°
@media (max-width: 768px) {
    .lyric-content {
        padding: 16px;
        gap: 12px;
    }

    .lyric-container {
        padding: 16px 20px;
        gap: 12px;

        .lyric-prefix {
            font-size: 14px;
            color: #666666;
        }

        .current-lyric {
            max-width: 400px;
            min-height: 50px;
        }
    }
}

@media (max-width: 480px) {
    .lyric-content {
        padding: 12px;
        gap: 8px;
    }

    .lyric-container {
        padding: 12px 16px;
        gap: 8px;

        .lyric-prefix {
            font-size: 12px;
            color: #666666;
        }

        .current-lyric {
            max-width: 300px;
            min-height: 45px;
        }
    }
}
</style>
